
import { useState } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { Progress } from "@/components/ui/progress";
import { Zap, Shield, AlertTriangle, Upload, Download, Eye } from "lucide-react";
import { useToast } from "@/hooks/use-toast";

interface SectorRisk {
  id: string;
  sector: string;
  criticalDanger: string;
  description: string;
  probability: number;
  gravity: number;
  initialRisk: number;
  controlMeasures: string;
  controlEffectiveness: number;
  residualRisk: number;
  status: string;
  responsible: string;
  legalRef: string;
}

const energySectorRisks: SectorRisk[] = [
  {
    id: "EN-RC2-001",
    sector: "Production Ã©nergÃ©tique",
    criticalDanger: "RC2 - Ã‰lectricitÃ©",
    description: "Contact avec Ã©quipements sous tension lors de maintenance",
    probability: 3,
    gravity: 5,
    initialRisk: 15,
    controlMeasures: "Cadenassage; Mise Ã  la terre; Permis de travail Ã©lectrique; Formation spÃ©cialisÃ©e",
    controlEffectiveness: 85,
    residualRisk: 2.25,
    status: "ContrÃ´lÃ©",
    responsible: "Chef d'Ã©quipe maintenance",
    legalRef: "LSST art.51; Code Ã©lectrique; RSST art.188"
  },
  {
    id: "EN-RC2-002", 
    sector: "Distribution Ã©lectrique",
    criticalDanger: "RC2 - Ã‰lectricitÃ©",
    description: "Ã‰lectrocution lors d'intervention sur rÃ©seau aprÃ¨s intempÃ©ries",
    probability: 4,
    gravity: 5,
    initialRisk: 20,
    controlMeasures: "VÃ©rification d'absence de tension; EPI isolants; Communication en binÃ´me",
    controlEffectiveness: 80,
    residualRisk: 4.0,
    status: "En surveillance",
    responsible: "Superviseur terrain",
    legalRef: "LSST art.51; Code Ã©lectrique art.2-304; RSST art.330"
  },
  {
    id: "EN-RC4-001",
    sector: "Construction Ã©lectrique",
    criticalDanger: "RC4 - Ã‰quipements de levage",
    description: "Chute de charge lors du levage d'Ã©quipements lourds",
    probability: 3,
    gravity: 5,
    initialRisk: 15,
    controlMeasures: "Plan de levage certifiÃ©; Inspection Ã©quipements; Zone d'exclusion; Ã‰lingues surdimensionnÃ©es",
    controlEffectiveness: 85,
    residualRisk: 2.25,
    status: "ContrÃ´lÃ©",
    responsible: "Responsable de chantier",
    legalRef: "LSST art.51(7); RSST art.254"
  },
  {
    id: "EN-RC8-001",
    sector: "Infrastructure Ã©nergÃ©tique",
    criticalDanger: "RC8 - Chute et effondrement",
    description: "Effondrement de structure temporaire en centrale",
    probability: 2,
    gravity: 5,
    initialRisk: 10,
    controlMeasures: "Validation ingÃ©nierie; Inspection quotidienne; SystÃ¨me d'alerte; Limitation d'accÃ¨s",
    controlEffectiveness: 80,
    residualRisk: 2.0,
    status: "ContrÃ´lÃ©",
    responsible: "IngÃ©nieur structure",
    legalRef: "LSST art.51(6); CSTC art.2.4.1"
  },
  {
    id: "EN-RC3-001",
    sector: "Exploitation rÃ©seau",
    criticalDanger: "RC3 - Incendies et explosions",
    description: "Incendie lors de surcharge rÃ©seau en pÃ©riode de pointe",
    probability: 2,
    gravity: 5,
    initialRisk: 10,
    controlMeasures: "DÃ©tection prÃ©coce; ProcÃ©dure d'urgence; Formation lutte incendie; Protection surdimensionnÃ©e",
    controlEffectiveness: 85,
    residualRisk: 1.5,
    status: "ContrÃ´lÃ©",
    responsible: "Chef d'exploitation",
    legalRef: "CNPI art.2.8; RSST art.45"
  },
  {
    id: "EN-RC5-001",
    sector: "Travaux en hauteur",
    criticalDanger: "RC5 - Chute de hauteur",
    description: "Chute de hauteur lors de travaux sur infrastructures Ã©levÃ©es",
    probability: 3,
    gravity: 5,
    initialRisk: 15,
    controlMeasures: "SystÃ¨me antichute certifiÃ©; Points d'ancrage validÃ©s; Formation; Permis de travail",
    controlEffectiveness: 80,
    residualRisk: 3.0,
    status: "En surveillance",
    responsible: "Coordonnateur SST",
    legalRef: "LSST art.51(3); CSTC art.2.9.2"
  },
  {
    id: "EN-RC9-001",
    sector: "Maintenance industrielle",
    criticalDanger: "RC9 - Autres risques professionnels",
    description: "Exposition Ã  substances dangereuses lors d'intervention sur Ã©quipements",
    probability: 3,
    gravity: 3,
    initialRisk: 9,
    controlMeasures: "ProcÃ©dure sÃ©curitaire; EPI chimique; Bacs de rÃ©tention; Trousse dÃ©versement",
    controlEffectiveness: 75,
    residualRisk: 2.25,
    status: "ContrÃ´lÃ©",
    responsible: "Technicien environnement",
    legalRef: "SIMDUT 2015; RSST art.299-304"
  },
  {
    id: "EN-RC10-001",
    sector: "Espaces confinÃ©s",
    criticalDanger: "RC10 - Espace clos",
    description: "Asphyxie lors d'intervention en espace clos technique",
    probability: 2,
    gravity: 5,
    initialRisk: 10,
    controlMeasures: "DÃ©tection 4 gaz; Ventilation forcÃ©e; Surveillant formÃ©; ProcÃ©dure de sauvetage",
    controlEffectiveness: 90,
    residualRisk: 1.0,
    status: "ContrÃ´lÃ©",
    responsible: "Coordonnateur travaux spÃ©ciaux",
    legalRef: "RSST art.297-312; CSTC art.3.21"
  },
  {
    id: "EN-RC6-001",
    sector: "Travail extÃ©rieur",
    criticalDanger: "RC6 - Conditions mÃ©tÃ©orologiques",
    description: "Exposition Ã  des conditions mÃ©tÃ©orologiques extrÃªmes",
    probability: 4,
    gravity: 3,
    initialRisk: 12,
    controlMeasures: "Rotation Ã©quipes; Abris climatisÃ©s; Ã‰quipements adaptÃ©s; ProcÃ©dure d'arrÃªt",
    controlEffectiveness: 70,
    residualRisk: 3.6,
    status: "En surveillance",
    responsible: "Superviseur terrain",
    legalRef: "LSST art.51(5); RSST art.123"
  },
  {
    id: "EN-RC7-001",
    sector: "Centre de contrÃ´le",
    criticalDanger: "RC7 - Ergonomie",
    description: "Troubles musculo-squelettiques opÃ©rateurs centres de contrÃ´le",
    probability: 3,
    gravity: 3,
    initialRisk: 9,
    controlMeasures: "Postes ergonomiques; Pauses programmÃ©es; Formation; Rotation des tÃ¢ches",
    controlEffectiveness: 65,
    residualRisk: 3.15,
    status: "En surveillance",
    responsible: "Responsable santÃ©",
    legalRef: "LSST art.51(3); RSST art.166"
  }
];

export function SectorRiskImporter({ onRisksImported }: { onRisksImported: (risks: SectorRisk[]) => void }) {
  const [selectedRisks, setSelectedRisks] = useState<string[]>([]);
  const [importProgress, setImportProgress] = useState(0);
  const [isImporting, setIsImporting] = useState(false);
  const [activeTab, setActiveTab] = useState("preview");
  const { toast } = useToast();

  const handleSelectRisk = (riskId: string) => {
    setSelectedRisks(prev => 
      prev.includes(riskId) 
        ? prev.filter(id => id !== riskId)
        : [...prev, riskId]
    );
  };

  const handleSelectAll = () => {
    setSelectedRisks(energySectorRisks.map(r => r.id));
  };

  const handleDeselectAll = () => {
    setSelectedRisks([]);
  };

  const handleImportRisks = async () => {
    setIsImporting(true);
    setImportProgress(0);

    const selectedRiskObjects = energySectorRisks.filter(r => selectedRisks.includes(r.id));

    // Simulation du processus d'import
    for (let i = 0; i <= 100; i += 10) {
      setImportProgress(i);
      await new Promise(resolve => setTimeout(resolve, 100));
    }

    onRisksImported(selectedRiskObjects);
    
    toast({
      title: "Risques sectoriels importÃ©s",
      description: `${selectedRiskObjects.length} risques du secteur Ã©nergÃ©tique ont Ã©tÃ© intÃ©grÃ©s au registre PPAI`,
    });

    setIsImporting(false);
    setActiveTab("integration");
  };

  const exportToCSV = () => {
    const csvContent = [
      "ID_Risque,Secteur,Danger_Critique,Description,ProbabilitÃ©,GravitÃ©,Risque_Initial,Mesures_ContrÃ´le,EfficacitÃ©_ContrÃ´le,Risque_RÃ©siduel,Statut,Responsable,RÃ©fÃ©rences_LÃ©gales",
      ...energySectorRisks.map(risk => 
        `"${risk.id}","${risk.sector}","${risk.criticalDanger}","${risk.description}",${risk.probability},${risk.gravity},${risk.initialRisk},"${risk.controlMeasures}",${risk.controlEffectiveness}%,${risk.residualRisk},"${risk.status}","${risk.responsible}","${risk.legalRef}"`
      )
    ].join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'risques-secteur-energetique.csv';
    link.click();
  };

  const getRiskLevelColor = (risk: number) => {
    if (risk >= 15) return "bg-red-100 text-red-800";
    if (risk >= 10) return "bg-orange-100 text-orange-800";
    if (risk >= 5) return "bg-yellow-100 text-yellow-800";
    return "bg-green-100 text-green-800";
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case "ContrÃ´lÃ©": return "bg-green-100 text-green-800";
      case "En surveillance": return "bg-orange-100 text-orange-800";
      case "Action requise": return "bg-red-100 text-red-800";
      default: return "bg-gray-100 text-gray-800";
    }
  };

  return (
    <div className="space-y-6">
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Zap className="w-6 h-6 text-blue-600" />
            Registre des Risques Sectoriels - Secteur Ã‰nergÃ©tique
          </CardTitle>
          <p className="text-sm text-gray-600">
            Importez des risques prÃ©-identifiÃ©s spÃ©cifiques au secteur Ã©nergÃ©tique dans votre registre PPAI
          </p>
        </CardHeader>
        <CardContent>
          <Tabs value={activeTab} onValueChange={setActiveTab} className="w-full">
            <TabsList className="grid w-full grid-cols-3">
              <TabsTrigger value="preview">ğŸ“‹ AperÃ§u des risques</TabsTrigger>
              <TabsTrigger value="selection">âœ… SÃ©lection</TabsTrigger>
              <TabsTrigger value="integration" disabled={!selectedRisks.length}>ğŸ”— IntÃ©gration</TabsTrigger>
            </TabsList>

            <TabsContent value="preview" className="space-y-4">
              <div className="flex justify-between items-center">
                <div className="grid grid-cols-4 gap-4">
                  <Card>
                    <CardContent className="p-3 text-center">
                      <div className="text-2xl font-bold text-blue-600">{energySectorRisks.length}</div>
                      <div className="text-xs text-gray-600">Risques disponibles</div>
                    </CardContent>
                  </Card>
                  <Card>
                    <CardContent className="p-3 text-center">
                      <div className="text-2xl font-bold text-red-600">
                        {energySectorRisks.filter(r => r.initialRisk >= 15).length}
                      </div>
                      <div className="text-xs text-gray-600">Risques critiques</div>
                    </CardContent>
                  </Card>
                  <Card>
                    <CardContent className="p-3 text-center">
                      <div className="text-2xl font-bold text-green-600">
                        {energySectorRisks.filter(r => r.status === "ContrÃ´lÃ©").length}
                      </div>
                      <div className="text-xs text-gray-600">ContrÃ´lÃ©s</div>
                    </CardContent>
                  </Card>
                  <Card>
                    <CardContent className="p-3 text-center">
                      <div className="text-2xl font-bold text-orange-600">
                        {(energySectorRisks.reduce((acc, r) => acc + r.controlEffectiveness, 0) / energySectorRisks.length).toFixed(0)}%
                      </div>
                      <div className="text-xs text-gray-600">EfficacitÃ© moyenne</div>
                    </CardContent>
                  </Card>
                </div>
                <Button onClick={exportToCSV} variant="outline" className="flex items-center gap-2">
                  <Download className="w-4 h-4" />
                  Exporter CSV
                </Button>
              </div>

              <div className="overflow-x-auto border rounded-lg">
                <table className="w-full text-sm">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-3 py-2 text-left">ID</th>
                      <th className="px-3 py-2 text-left">Secteur</th>
                      <th className="px-3 py-2 text-left">Danger</th>
                      <th className="px-3 py-2 text-left">Description</th>
                      <th className="px-3 py-2 text-center">PÃ—G</th>
                      <th className="px-3 py-2 text-center">EfficacitÃ©</th>
                      <th className="px-3 py-2 text-center">Statut</th>
                    </tr>
                  </thead>
                  <tbody>
                    {energySectorRisks.map((risk) => (
                      <tr key={risk.id} className="border-b hover:bg-gray-50">
                        <td className="px-3 py-2 font-mono text-xs">{risk.id}</td>
                        <td className="px-3 py-2">{risk.sector}</td>
                        <td className="px-3 py-2">
                          <Badge variant="outline" className="text-xs">
                            {risk.criticalDanger}
                          </Badge>
                        </td>
                        <td className="px-3 py-2 max-w-xs truncate">{risk.description}</td>
                        <td className="px-3 py-2 text-center">
                          <Badge className={getRiskLevelColor(risk.initialRisk)}>
                            {risk.initialRisk}
                          </Badge>
                        </td>
                        <td className="px-3 py-2 text-center">{risk.controlEffectiveness}%</td>
                        <td className="px-3 py-2 text-center">
                          <Badge className={getStatusColor(risk.status)}>
                            {risk.status}
                          </Badge>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </TabsContent>

            <TabsContent value="selection" className="space-y-4">
              <div className="flex justify-between items-center">
                <div>
                  <h4 className="font-medium">SÃ©lectionner les risques Ã  importer</h4>
                  <p className="text-sm text-gray-600">
                    {selectedRisks.length} risque(s) sÃ©lectionnÃ©(s) sur {energySectorRisks.length}
                  </p>
                </div>
                <div className="flex gap-2">
                  <Button onClick={handleSelectAll} variant="outline" size="sm">
                    Tout sÃ©lectionner
                  </Button>
                  <Button onClick={handleDeselectAll} variant="outline" size="sm">
                    Tout dÃ©sÃ©lectionner
                  </Button>
                </div>
              </div>

              <div className="grid gap-3">
                {energySectorRisks.map((risk) => (
                  <Card key={risk.id} className={`cursor-pointer transition-colors ${
                    selectedRisks.includes(risk.id) ? 'border-blue-500 bg-blue-50' : 'hover:bg-gray-50'
                  }`} onClick={() => handleSelectRisk(risk.id)}>
                    <CardContent className="p-4">
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-2">
                            <input
                              type="checkbox"
                              checked={selectedRisks.includes(risk.id)}
                              onChange={() => handleSelectRisk(risk.id)}
                              className="w-4 h-4"
                            />
                            <span className="font-mono text-sm font-medium">{risk.id}</span>
                            <Badge variant="outline">{risk.criticalDanger}</Badge>
                            <Badge className={getRiskLevelColor(risk.initialRisk)}>
                              Risque: {risk.initialRisk}
                            </Badge>
                          </div>
                          <h5 className="font-medium mb-1">{risk.description}</h5>
                          <p className="text-sm text-gray-600 mb-2">
                            <strong>Secteur:</strong> {risk.sector} | 
                            <strong> Responsable:</strong> {risk.responsible}
                          </p>
                          <p className="text-xs text-gray-500 mb-2">
                            <strong>Mesures:</strong> {risk.controlMeasures}
                          </p>
                        </div>
                        <div className="text-right">
                          <Badge className={getStatusColor(risk.status)}>
                            {risk.status}
                          </Badge>
                          <div className="text-sm text-gray-600 mt-1">
                            EfficacitÃ©: {risk.controlEffectiveness}%
                          </div>
                          <div className="text-sm text-gray-600">
                            RÃ©siduel: {risk.residualRisk}
                          </div>
                        </div>
                      </div>
                    </CardContent>
                  </Card>
                ))}
              </div>

              {selectedRisks.length > 0 && (
                <div className="flex justify-end">
                  <Button onClick={handleImportRisks} disabled={isImporting} size="lg">
                    <Upload className="w-4 h-4 mr-2" />
                    Importer {selectedRisks.length} risque(s) sÃ©lectionnÃ©(s)
                  </Button>
                </div>
              )}
            </TabsContent>

            <TabsContent value="integration" className="space-y-4">
              {isImporting && (
                <Card>
                  <CardContent className="p-4">
                    <h4 className="font-medium mb-2">IntÃ©gration en cours...</h4>
                    <Progress value={importProgress} className="mb-2" />
                    <p className="text-sm text-gray-600">{importProgress}% - IntÃ©gration des risques sectoriels</p>
                  </CardContent>
                </Card>
              )}

              {!isImporting && selectedRisks.length > 0 && (
                <Alert>
                  <Shield className="w-4 h-4" />
                  <AlertDescription>
                    <strong>IntÃ©gration rÃ©ussie !</strong> Les risques sectoriels ont Ã©tÃ© intÃ©grÃ©s Ã  votre registre PPAI.
                    Ces donnÃ©es seront maintenant utilisÃ©es pour personnaliser vos programmes de prÃ©vention.
                  </AlertDescription>
                </Alert>
              )}
            </TabsContent>
          </Tabs>
        </CardContent>
      </Card>
    </div>
  );
}
